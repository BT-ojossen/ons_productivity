<%page args="account, formatLang" />

%if account.ledger_lines and account.partners_order:
    <%
    account_total_debit = 0.0
    account_total_credit = 0.0
    account_balance_cumul = 0.0
    account_balance_cumul_curr = 0.0
    %>

    %for partner_name, p_id, p_ref, p_name in account.partners_order:
    <%
      total_debit = 0.0
      total_credit = 0.0
      cumul_balance = 0.0
      cumul_balance_curr = 0.0
      part_cumul_balance = 0.0
      part_cumul_balance_curr = 0.0 
    %>
    
<div class="global"> 
<br/><br/><br/><br/>
<!----- CUSTOMER INFO ----->
<div class="address">
	${get_partner(p_id).name |entity}<br />
	%if get_partner(p_id).street :
		${get_partner(p_id).street or ''|entity}<br />
	%endif
	%if get_partner(p_id).street2 :
		${get_partner(p_id).street2 or ''|entity}<br />
	%endif
	%if get_partner(p_id).zip :
		${get_partner(p_id).zip or ''|entity}
	%endif 
	%if get_partner(p_id).city :
		${get_partner(p_id).city or ''|entity}<br /> 
	%endif 
	%if get_partner(p_id).country_id :
		%if get_partner(p_id).country_id.code != 'CH':
			${get_partner(p_id).country_id.name or ''  |entity}<br />
		%endif 
	%endif 
</div> 
<br/><br/><br/><br/>
 <div class="date">
   <i>Chavannes, ${time.strftime("%d.%m.%Y", time.localtime())}</i>
</div>

<!-----  COMMENTS OR OTHER INFO  ----->
<div class="comment">
	<span class="comment">
		Cher client veuillez trouver ci-dessous votre releve√© de compte a la date du ${ formatLang(date_until, date=True) }

	</span>
</div>


<div class="act_as_table list_table" style="margin-top: 5px;">
 
        <div class="act_as_thead">
            <div class="act_as_row labels">
                ## date
                <div class="act_as_cell first_column" style="width: 60px;">${_('Date')}</div>
                ## move
                <div class="act_as_cell" style="width: 70px;">${_('Entry')}</div>
                ## label
                <div class="act_as_cell" style="width: 100px;">${_('Label')}</div>
                ## reconcile
                <div class="act_as_cell" style="width: 60px;">${_('Rec.')}</div>
                ## maturity
                <div class="act_as_cell" style="width: 60px;">${_('Due Date')}</div>
                ## debit
                <div class="act_as_cell amount" style="width: 80px;">${_('Debit')}</div>
                ## credit
                <div class="act_as_cell amount" style="width: 80px;">${_('Credit')}</div>
                ## balance cumulated
                <div class="act_as_cell amount" style="width: 80px;">${_('Cumul. Bal.')}</div>
                %if amount_currency(data):
                    ## currency balance
                    <div class="act_as_cell amount sep_left" style="width: 80px;">${_('Curr. Balance')}</div>
                   ## curency code
                   <div class="act_as_cell amount" style="width: 30px; text-align: right;">${_('Curr.')}</div>
                %endif
            </div>
        </div>
        <div class="act_as_tbody">
            <%
            total_debit = 0.0
            total_credit = 0.0
            %>
           <%!
            def amount(text):
                return text.replace('-', '&#8209;')  # replace by a non-breaking hyphen (it will not word-wrap between hyphen and numbers)
            %>
            %for line in account.ledger_lines.get(p_id, []):
              <%
              total_debit += line.get('debit') or 0.0
              total_credit += line.get('credit') or 0.0

              label_elements = [line.get('lname') or '']
              if line.get('invoice_number'):
                label_elements.append("(%s)" % (line['invoice_number'],))
              label = ' '.join(label_elements)
              %>
                <div class="act_as_row lines ${line.get('is_from_previous_periods') and 'open_invoice_previous_line' or ''} ${line.get('is_clearance_line') and 'clearance_line' or ''}">
                  ## date
                  <div class="act_as_cell first_column">${formatLang(line.get('ldate') or '', date=True)}</div>
                  ## move
                  <div class="act_as_cell">${line.get('move_name') or ''}</div>
                  ## label
                  <div class="act_as_cell">${label}</div>
                  ## reconcile
                  <div class="act_as_cell">${line.get('rec_name') or ''}</div>
                  ## maturity date
                  <div class="act_as_cell">${formatLang(line.get('date_maturity') or '', date=True)}</div>
                  ## debit
                  <div class="act_as_cell amount">${formatLang(line.get('debit') or 0.0) | amount }</div>
                  ## credit
                  <div class="act_as_cell amount">${formatLang(line.get('credit') or 0.0) | amount }</div>
                  ## balance cumulated
                  <div class="act_as_cell amount" style="padding-right: 1px;"> <% cumul_balance += line.get('balance') or 0.0 %></div>
              </div>
            %endfor
            <div class="act_as_row lines labels">
              <div class="act_as_cell first_column"></div>
              <div class="act_as_cell"></div>
              <div class="act_as_cell"></div>
              <div class="act_as_cell"></div>
              ## label
              <div class="act_as_cell"><br/><b>${_('Total')}</b></div>
              ## debit
              <div class="act_as_cell amount"><br/><b>${formatLang(total_debit) | amount }</b></div>
              ## credit
              <div class="act_as_cell amount"><br/><b>${formatLang(total_credit) | amount }</b></div>
              ## balance cumulated
              <div class="act_as_cell amount" style="padding-right: 1px;"><br/><b>${formatLang(cumul_balance) | amount }</b></div>
              %if amount_currency(data):
                  %if account.currency_id:
                      ## currency balance
                      <div class="act_as_cell sep_left amount" style="padding-right: 1px;"><br/><b>${formatLang(cumul_balance_curr) | amount }</b></div>
                  %else:
                      <div class="act_as_cell sep_left amount" style="padding-right: 1px;"><br/><b>${ u'-' }</b></div>
                  %endif
                  ## curency code
                  <div class="act_as_cell" style="text-align: right; "><br/><b>${ account.currency_id.name if account.currency_id else u'' }</b></div>
              %endif
          </div>
        </div>
    </div>
    <%
        account_total_debit += total_debit
        account_total_credit += total_credit
        account_balance_cumul += cumul_balance
        account_balance_cumul_curr += cumul_balance_curr
    %>
   
</div>   
<p style="page-break-after:always"></p>  
    
%endfor

%endif